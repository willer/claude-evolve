#!/bin/bash

set -e

# Load configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=../lib/config.sh
source "$SCRIPT_DIR/../lib/config.sh"

# Use CLAUDE_EVOLVE_CONFIG if set, otherwise default
if [[ -n ${CLAUDE_EVOLVE_CONFIG:-} ]]; then
  load_config "$CLAUDE_EVOLVE_CONFIG"
else
  load_config
fi

# Parse arguments
open_chart=false
csv_file="$FULL_CSV_PATH"
output_file=""  # Will be set later if not specified

while [[ $# -gt 0 ]]; do
  case $1 in
  --help)
    cat <<EOF
claude-evolve analyze - Analyze evolution results

USAGE:
  claude-evolve analyze [--open] [--csv <path>] [--output <path>]

OPTIONS:
  --open            Open the generated chart automatically
  --csv <path>      Path to evolution.csv (default: ./evolution/evolution.csv)
  --output <path>   Output path for chart PNG (default: ./evolution/performance.png)
  --help            Show this help message

DESCRIPTION:
  Analyzes the evolution.csv file and generates a performance chart.
  Displays summary statistics and identifies the top performing algorithm.
EOF
    exit 0
    ;;
  --open)
    open_chart=true
    shift
    ;;
  --csv)
    csv_file="$2"
    shift 2
    ;;
  --output)
    output_file="$2"
    shift 2
    ;;
  *)
    echo "[ERROR] Unknown option: $1" >&2
    exit 1
    ;;
  esac
done

# Set default output file if not specified
if [[ -z "$output_file" ]]; then
  if [[ -d "$FULL_OUTPUT_DIR" ]]; then
    # We're in an evolution workspace
    output_file="$FULL_OUTPUT_DIR/performance.png"
  else
    # Not in workspace, use temp file
    output_file="/tmp/claude_evolve_performance_$$.png"
  fi
fi

# Check if CSV exists
if [[ ! -f $csv_file ]]; then
  echo "[ERROR] CSV file not found: $csv_file" >&2
  echo "[ERROR] Run 'claude-evolve setup' and 'claude-evolve ideate' first." >&2
  exit 1
fi

echo "=== Evolution Analysis Summary ==="
echo

# Count totals (pure shell)
total=0
completed=0
running=0
failed=0
pending=0
total_performance=0
count_with_performance=0
top_score=""
top_id=""
top_desc=""

while IFS=, read -r id _ desc perf status; do
  [[ $id == "id" ]] && continue # Skip header

  ((total++))

  case "$status" in
  "complete" | "completed") 
    ((completed++))
    # Only count performance for completed runs with non-zero values
    if [[ -n $perf && $perf != "" ]]; then
      # Skip zeros (they're errors)
      if (( $(echo "$perf > 0" | bc -l 2>/dev/null || echo "0") )); then
        total_performance=$(echo "$total_performance + $perf" | bc -l 2>/dev/null || echo "$total_performance")
        ((count_with_performance++))

        # Check if this is the top performer
        if [[ -z $top_score ]] || (($(echo "$perf > $top_score" | bc -l 2>/dev/null || echo "0"))); then
          top_score="$perf"
          top_id="$id"
          top_desc="$desc"
        fi
      fi
    fi
    ;;
  "running") ((running++)) ;;
  "failed" | "timeout" | "interrupted") ((failed++)) ;;
  *) ((pending++)) ;;
  esac
done <"$csv_file"

# Display summary
echo "Total Candidates: $total"
echo "Completed: $completed"
echo "Running: $running"
echo "Failed: $failed"
echo "Pending: $pending"

if [[ $count_with_performance -gt 0 ]]; then
  avg_performance=$(echo "scale=4; $total_performance / $count_with_performance" | bc -l 2>/dev/null || echo "0")
  echo "Average Performance: $avg_performance"
else
  echo "Average Performance: N/A"
fi

echo
echo "=== Top Performer ==="
if [[ -n $top_id ]]; then
  echo "ID: $top_id"
  echo "Performance: $top_score"
  echo "Description: $top_desc"
else
  echo "No completed candidates yet"
fi

# Generation analysis
echo
echo "=== Generation Analysis ==="

# Create temporary file for generation stats
gen_stats_file="/tmp/evolution_gen_stats_$$.tmp"
>"$gen_stats_file"

while IFS=, read -r id _ desc perf status; do
  [[ $id == "id" ]] && continue # Skip header
  
  # Extract generation from ID
  gen="gen01" # default for old numeric IDs
  if [[ $id =~ ^(gen[0-9]+)- ]]; then
    gen="${BASH_REMATCH[1]}"
  elif [[ $id =~ ^[0-9]+$ ]]; then
    gen="gen00" # Mark old numeric IDs as gen00
  fi
  
  # Write generation data to temp file
  echo -n "$gen " >> "$gen_stats_file"
  if [[ $status =~ ^(complete|completed)$ && -n $perf && $perf != "" ]]; then
    # Exclude zeros from statistics (they're errors)
    if (( $(echo "$perf > 0" | bc -l 2>/dev/null || echo "0") )); then
      echo "completed $perf" >> "$gen_stats_file"
    else
      echo "error" >> "$gen_stats_file"
    fi
  else
    echo "incomplete" >> "$gen_stats_file"
  fi
done <"$csv_file"

# Process generation stats
for gen in $(cut -d' ' -f1 "$gen_stats_file" | sort -u || echo ""); do
  [[ -z "$gen" ]] && continue
  total_in_gen=$(grep -c "^$gen " "$gen_stats_file" 2>/dev/null || echo "0")
  completed_in_gen=$(grep -c "^$gen completed" "$gen_stats_file" 2>/dev/null || echo "0")
  # Clean any whitespace from the numbers
  completed_in_gen=$(echo "$completed_in_gen" | tr -d '[:space:]')
  
  echo -n "$gen: $total_in_gen candidates"
  
  if [[ "$completed_in_gen" -gt 0 ]]; then
    # Calculate average performance for this generation  
    sum="0"
    if grep -q "^$gen completed" "$gen_stats_file"; then
      sum=$(grep "^$gen completed" "$gen_stats_file" | awk '{s+=$3} END {printf "%.6f", s}' 2>/dev/null || echo "0")
    fi
    avg=$(echo "scale=4; $sum / $completed_in_gen" | bc -l 2>/dev/null || echo "0")
    echo " ($completed_in_gen completed, avg: $avg)"
  else
    echo " (0 completed)"
  fi
done

rm -f "$gen_stats_file"

# Count valid performance entries for chart (excluding zeros)
valid_performance_count=0
while IFS=, read -r id _ desc perf status; do
  [[ $id == "id" ]] && continue # Skip header
  if [[ $status =~ ^(complete|completed)$ && -n $perf && $perf != "" ]]; then
    if (( $(echo "$perf > 0" | bc -l 2>/dev/null || echo "0") )); then
      ((valid_performance_count++))
    fi
  fi
done <"$csv_file"

# Simple chart generation using gnuplot if available
if command -v gnuplot >/dev/null 2>&1 && [[ $valid_performance_count -gt 0 ]]; then
  echo
  echo "Generating performance chart: $output_file"

  # Create data files for gnuplot
  data_file="/tmp/evolution_data_$$.dat"
  winner_file="/tmp/evolution_winner_$$.dat"
  gen_avg_file="/tmp/evolution_gen_avg_$$.dat"
  
  echo "# Row ID Performance Generation" >"$data_file"
  echo "# Generation AvgPerformance Color" >"$gen_avg_file"

  # Get color by generation number (rotates through 5 colors)
  get_gen_color() {
    local gen_num="$1"
    local color_index=$(( (gen_num - 1) % 5 + 1 ))
    case $color_index in
      1) echo "#1f77b4" ;;  # blue
      2) echo "#ff7f0e" ;;  # orange  
      3) echo "#2ca02c" ;;  # green
      4) echo "#d62728" ;;  # red
      5) echo "#9467bd" ;;  # purple
    esac
  }

  # Create temporary files for generation tracking
  gen_data_temp="/tmp/evolution_gen_temp_$$.dat"
  >"$gen_data_temp"
  
  row_num=0
  max_perf=0
  max_row=0
  max_id=""
  
  while IFS=, read -r id _ desc perf status; do
    [[ $id == "id" ]] && continue # Skip header
    ((row_num++))
    
    # Extract generation from ID
    gen="gen01" # default
    if [[ $id =~ ^(gen[0-9]+)- ]]; then
      gen="${BASH_REMATCH[1]}"
    fi
    
    # Only include completed algorithms with non-zero performance
    if [[ -n $perf && $perf != "" && $status =~ ^(complete|completed)$ ]]; then
      # Skip zero values (they're errors)
      if (( $(echo "$perf > 0" | bc -l) )); then
        # Assign generation number for coloring (1-based)
        gen_num=1
        if [[ $id =~ ^gen([0-9]+)- ]]; then
          gen_num=$((10#${BASH_REMATCH[1]}))
        fi
        
        echo "$row_num \"$id\" $perf $gen_num" >>"$data_file"
        
        # Track for generation averages
        echo "$gen $perf" >>"$gen_data_temp"
        
        # Track the winner
        if (( $(echo "$perf > $max_perf" | bc -l) )); then
          max_perf=$perf
          max_row=$row_num
          max_id=$id
        fi
      fi
    fi
  done <"$csv_file"

  # Create generation averages file and track max generation
  gen_index=1
  max_gen_num=0
  for gen in $(cut -d' ' -f1 "$gen_data_temp" | sort -u); do
    if grep -q "^$gen " "$gen_data_temp"; then
      # Calculate average for this generation
      sum=$(grep "^$gen " "$gen_data_temp" | awk '{s+=$2} END {printf "%.6f", s}' 2>/dev/null || echo "0")
      count=$(grep -c "^$gen " "$gen_data_temp")
      if [[ $count -gt 0 ]]; then
        avg=$(echo "scale=4; $sum / $count" | bc -l 2>/dev/null || echo "0")
        gen_num=$(echo "$gen" | sed 's/gen0*//')
        # Track max generation number
        if [[ $gen_num -gt $max_gen_num ]]; then
          max_gen_num=$gen_num
        fi
        color=$(get_gen_color "$gen_num")
        echo "$gen_index \"$gen\" $avg \"$color\"" >>"$gen_avg_file"
        ((gen_index++))
      fi
    fi
  done

  # Create winner data point
  if [[ -n $max_id ]]; then
    echo "$max_row \"$max_id\" $max_perf" >"$winner_file"
  fi

  # Generate dual plot
  if [[ -s "$data_file" ]]; then
    # Build dynamic plot command for generations
    plot_cmd=""
    for ((i=1; i<=max_gen_num; i++)); do
      color=$(get_gen_color "$i")
      if [[ -n $plot_cmd ]]; then
        plot_cmd="$plot_cmd, \\"$'\n'
      fi
      plot_cmd="${plot_cmd}     \"$data_file\" using (\$4==$i?\$1:1/0):3 with linespoints linewidth 2 linecolor rgb \"$color\" pointsize 0.8 title \"Gen $i\""
    done
    # Add winner point
    plot_cmd="$plot_cmd, \\"$'\n'
    plot_cmd="${plot_cmd}     \"$winner_file\" using 1:3 with points pointtype 7 pointsize 2 linecolor rgb \"#0066cc\" title \"Winner\""
    
    # Build x-axis labels for generation chart
    xtics_labels=""
    for ((i=1; i<=max_gen_num; i++)); do
      if [[ -n $xtics_labels ]]; then
        xtics_labels="$xtics_labels, "
      fi
      xtics_labels="${xtics_labels}\"Gen$i\" $i"
    done
    
    gnuplot <<EOF
set terminal png size 1200,800
set output "$output_file"

# Set up multiplot with proper spacing
set multiplot layout 2,1 margins 0.08,0.82,0.15,0.95 spacing 0.1,0.15

#=================== TOP PLOT: Performance Over Time ===================
set title "Algorithm Evolution Performance Over Time" font ",14"
set xlabel "Evolution Run"
set ylabel "Performance Score"
set grid
set key outside right
set xtics auto

# Define colors for generations
plot $plot_cmd

#=================== BOTTOM PLOT: Generation Averages ===================
set title "Average Performance by Generation" font ",14"
set xlabel "Generation"
set ylabel "Avg Performance"
set style fill solid 0.8
set boxwidth 0.6
unset key
set grid y

# Set custom x-axis labels
set xtics ($xtics_labels)

plot "$gen_avg_file" using 1:3 with boxes linecolor rgb "#4CAF50" notitle

unset multiplot

# Add winner label at bottom
set terminal png size 1200,830
set output "$output_file"
set label "Best Overall: $max_id (Score: $max_perf)" at screen 0.5, 0.05 center font ",12"
replot
EOF
  else
    echo "[WARN] No valid performance data to plot"
    exit 0
  fi

  rm -f "$data_file" "$winner_file" "$gen_avg_file" "$gen_data_temp"
  echo "Chart saved to: $output_file"

  # Always try to open chart (not just when --open is used)
  if command -v open >/dev/null 2>&1; then
    open "$output_file"
    echo "Opening chart..."
  elif command -v xdg-open >/dev/null 2>&1; then
    xdg-open "$output_file"
    echo "Opening chart..."
  else
    echo "[WARN] Cannot open chart automatically. View: $output_file"
  fi
else
  if [[ $valid_performance_count -eq 0 ]]; then
    echo
    echo "No valid performance data available for chart generation."
    echo "Run 'claude-evolve run' to execute candidates first."
  else
    echo
    echo "[WARN] gnuplot not found. Install gnuplot for chart generation."
    echo "       On macOS: brew install gnuplot"
    echo "       On Ubuntu: sudo apt install gnuplot"
  fi
fi
